# Работа с Сервером

Работа с сервером происходит с помощью библиотек retrofit2, okhttp, gson, rxjava.

Для работы с сетью предусмотрены модули:
 * [network](../../network/README.md)
 * [Gson-конвертер](../../converter-gson/README.md)

При работе с сервером возникает необхдимость добавлять те или иные параметры
в запрос. Для этих целей хорошо подходит сущности типа `Interceptor`. Такие
сущности передаются в билдер OkHttp-клента.

Также удобно [логгировать][log] ответы сервера, а также ошибки парсинга на удаленный сервер
с целью быстрого нахождения ошибок. **Не следует логгировать пользовательские
данные**.

### Обработка ошибок

Так как используется RxJava/Kotlin, то все ошибки передаются в соответсвующие колбеки.
Обработка большинства ошибок происходит [на уровне Presenter'а][handle_errors_on_presenter].

Если на сервере существует механизм ошибок, когда не с 200-м кодом
приходит еще и тело ошибки, то такие сообщения следует приводить к специфичному
исключению. Эти операции следует производить на уровне [`CallAdapter`'а][call]

Ошибки парсинга Json (JsonSyntaxException) следует конвертировать в служебную
ошибку. Этим занимается [`Converter`][gson].

###### Открытие экранов по спец ошибкам

В случае если возникает необходимость открыть экран прямо из слоя Interactor,
например, когда у пользователя устарел токен и необходимо перекинуть его на экран
авторизации, необходимо использовать глобальный навигатор, поставляемый модулем
[core-ui](../../core-ui/README.md).
Это необходимо,  чтобы не тащить данную логику на ui.

### Кеширование данных

Хорошей практикой является кеширование загруженных данных. Например,
результатов поиска, пользовательского профиля, содержимого некого экрана.
Это необходимо, чтобы пользователь мог видеть уже загруженный им контент
без дополнительной перезагрузки.

Кешировать данные можно по-разному. Самые известные подходы - это:

- [простой кеш][simple_cache] - например в виде Url-кэша.В этом случае ответы сервера сохраняются
в файловую систему. Причем они сохраняются в соответствии с теми url, по
которым были получены.

    *Плюсы*:
     - быстрый

    *Минусы*:
    - нужен механизм обновления (например [etag][simple_cache])

- [объектное хранилище][file_cache] - кеширует объекты в файловую систему.
   В нашей реализации лежит в основе простого кеша.

- база данных - если нужен только кеш - не самое лучшее решение.
   БД создано для более сложных задач.

[TODO]: ../расписать_подробно

###### Гибридные запросы

### Маппинг ответов сервера

### Тесты API



[log]: ../common/logging.md
[gson]: ../../converter-gson/README.md
[call]: ../../network/README.md
[simple_cache]: ../../network/docs/usage.md#etag
[handle_errors_on_presenter]: ../ui/presenter.md
[file_cache]: ../../filestorage/README.md
